function [pres,temp,undu] =  gpt_v1 (dmjd,dlat,dlon,dhgt)

% This subroutine determines Global Pressure and Temperature
% based on Spherical Harmonics up to degree and order 9
% 
% input data
% ----------
% dmjd: modified julian date
% dlat: latitude in radians
% dlon: longitude in radians
% dhgt: ellipsoidal height in m
% 
% output data
% -----------
% pres: pressure in hPa
% temp: temperature in Celsius
% undu: Geoid undulation in m (from a 9x9 EGM based model)
% 
% Johannes Boehm, 2006 June 12
% rev 2006 June 16: geoid undulation is accounted for
% rev 2006 July 17: barometric height equation used instead of Berg (1948) for 
%                   the vertical extrapolation of the pressure
% 
% Reference:
% J. Boehm, R. Heinkelmann, and H. Schuh,
% Global Pressure and Temperature (GPT): A spherical harmonics expansion 
% of annual pressure and temperature variations for geodetic applications,
% submitted to Journal of Geodesy, 2006

doy = dmjd  - 44239.d0 + 1 - 28;

a_geoid = [ ... 
-5.6195d-001,-6.0794d-002,-2.0125d-001,-6.4180d-002,-3.6997d-002, ...
+1.0098d+001,+1.6436d+001,+1.4065d+001,+1.9881d+000,+6.4414d-001, ...
-4.7482d+000,-3.2290d+000,+5.0652d-001,+3.8279d-001,-2.6646d-002, ...
+1.7224d+000,-2.7970d-001,+6.8177d-001,-9.6658d-002,-1.5113d-002, ...
+2.9206d-003,-3.4621d+000,-3.8198d-001,+3.2306d-002,+6.9915d-003, ...
-2.3068d-003,-1.3548d-003,+4.7324d-006,+2.3527d+000,+1.2985d+000, ...
+2.1232d-001,+2.2571d-002,-3.7855d-003,+2.9449d-005,-1.6265d-004, ...
+1.1711d-007,+1.6732d+000,+1.9858d-001,+2.3975d-002,-9.0013d-004, ...
-2.2475d-003,-3.3095d-005,-1.2040d-005,+2.2010d-006,-1.0083d-006, ...
+8.6297d-001,+5.8231d-001,+2.0545d-002,-7.8110d-003,-1.4085d-004, ...
-8.8459d-006,+5.7256d-006,-1.5068d-006,+4.0095d-007,-2.4185d-008]; 

b_geoid = [ ... 
+0.0000d+000,+0.0000d+000,-6.5993d-002,+0.0000d+000,+6.5364d-002, ...
-5.8320d+000,+0.0000d+000,+1.6961d+000,-1.3557d+000,+1.2694d+000, ...
+0.0000d+000,-2.9310d+000,+9.4805d-001,-7.6243d-002,+4.1076d-002, ...
+0.0000d+000,-5.1808d-001,-3.4583d-001,-4.3632d-002,+2.2101d-003, ...
-1.0663d-002,+0.0000d+000,+1.0927d-001,-2.9463d-001,+1.4371d-003, ...
-1.1452d-002,-2.8156d-003,-3.5330d-004,+0.0000d+000,+4.4049d-001, ...
+5.5653d-002,-2.0396d-002,-1.7312d-003,+3.5805d-005,+7.2682d-005, ...
+2.2535d-006,+0.0000d+000,+1.9502d-002,+2.7919d-002,-8.1812d-003, ...
+4.4540d-004,+8.8663d-005,+5.5596d-005,+2.4826d-006,+1.0279d-006, ...
+0.0000d+000,+6.0529d-002,-3.5824d-002,-5.1367d-003,+3.0119d-005, ...
-2.9911d-005,+1.9844d-005,-1.2349d-006,-7.6756d-009,+5.0100d-008];

ap_mean = [ ... 
+1.0121e+003,+5.5433e+000,+9.3749e-001,-6.1759e+000,-3.2384e-001, ...
-2.6322e-001,+5.4379e+000,-3.2280e-001,-1.0638e-001,+2.1336e-002, ...
-7.0505e+000,+1.0145e-001,-1.1761e-001,+6.2937e-004,+3.4121e-003, ...
-4.3692e+000,+3.4855e-002,-7.1801e-002,+7.4585e-003,+1.2584e-004, ...
-2.0835e-004,+1.3209e+001,-5.9683e-001,-1.7999e-002,+1.1529e-002, ...
+1.3733e-003,-1.0486e-004,-7.9984e-005,-7.6073e+000,+2.4410e-002, ...
+1.6200e-002,+1.0132e-003,+4.5029e-004,+2.0978e-005,-2.3015e-005, ...
-6.9802e-007,+8.2586e+000,-4.4678e-001,-3.2043e-002,-1.3588e-003, ...
-5.1676e-004,+2.3866e-006,-1.4360e-005,+9.7697e-009,+2.4364e-007, ...
-5.2872e+000,+3.4611e-001,+4.3149e-002,+1.9655e-003,-1.1317e-004, ...
+3.8969e-006,-2.9672e-006,-1.6142e-008,+1.3634e-007,+1.8139e-009]; 

bp_mean = [ ... 
+0.0000e+000,+0.0000e+000,-8.6062e-001,+0.0000e+000,-7.3697e-003, ...
+1.7114e-001,+0.0000e+000,+6.6381e-001,-7.9105e-002,-5.2127e-002, ...
+0.0000e+000,-1.5558e-001,+5.4623e-003,-4.6676e-002,-1.9630e-003, ...
+0.0000e+000,+5.4487e-001,+5.4807e-002,-1.2782e-002,+3.6545e-003, ...
+1.2390e-004,+0.0000e+000,-1.0235e+000,-1.5411e-003,-3.8840e-003, ...
-2.0411e-004,+4.3870e-004,-3.9926e-005,+0.0000e+000,+8.0291e-001, ...
+1.4892e-002,+9.3109e-003,+1.2607e-004,+1.0431e-004,-5.0576e-006, ...
-3.5252e-006,+0.0000e+000,-1.5574e+000,-3.6200e-002,+1.3938e-003, ...
+1.8142e-005,+3.1914e-005,-3.0983e-006,-9.8549e-007,+2.4015e-008, ...
+0.0000e+000,+9.3945e-001,-2.1923e-002,+1.3576e-003,-2.1553e-004, ...
-8.5781e-006,-1.3729e-006,-5.5049e-007,+2.5084e-008,+5.7344e-009]; 

ap_amp = [ ... 
+2.1033e-001,+2.3378e+000,-7.0254e-002,+4.8026e-001,+5.3290e-001, ...
-5.3427e-001,-2.2414e+000,-1.4911e-001,-3.3159e-001,+4.6280e-002, ...
-2.5120e+000,-3.7463e-001,-2.3841e-001,+1.6697e-002,+3.4015e-003, ...
+4.4024e+000,-4.4105e-001,-9.9505e-002,+2.4434e-002,-4.7138e-004, ...
-7.3813e-005,-1.4033e-001,-4.4067e-001,-8.9305e-003,+4.6880e-003, ...
+1.0680e-003,-5.4825e-005,+8.7200e-006,+1.7920e+000,-1.6769e-001, ...
-1.2413e-002,+3.9209e-003,+3.5741e-004,-5.6932e-006,+9.3956e-006, ...
+1.0662e-006,+2.6382e-001,-9.3866e-002,+3.6743e-002,+9.8181e-004, ...
-6.9639e-005,+6.2443e-006,+2.3568e-006,+5.8293e-007,+6.9189e-008, ...
+1.6990e-001,-1.1030e-001,-4.6711e-003,-6.5713e-004,-4.2706e-005, ...
+9.2786e-007,+1.8322e-006,+1.2599e-007,+3.1129e-008,-5.3422e-010]; 

bp_amp = [ ... 
+0.0000e+000,+0.0000e+000,+1.3548e+000,+0.0000e+000,+1.5273e+000, ...
+2.6031e-001,+0.0000e+000,+9.1131e-001,-8.8366e-003,-1.7559e-002, ...
+0.0000e+000,-3.4931e-001,+1.4945e-002,+1.8671e-002,+6.4916e-004, ...
+0.0000e+000,-2.6579e-001,-4.7022e-002,-7.0600e-003,+6.4271e-005, ...
+7.5782e-005,+0.0000e+000,+3.2584e-002,-3.8444e-002,+4.4379e-003, ...
-2.7910e-004,-9.4048e-005,-1.4672e-005,+0.0000e+000,-4.3930e-001, ...
-2.0533e-002,-2.9032e-003,+1.9010e-005,+2.1762e-007,+8.0203e-007, ...
+3.8941e-008,+0.0000e+000,+3.6271e-001,-3.6792e-003,+2.6297e-003, ...
-6.8763e-005,-2.8159e-006,-1.6269e-006,-4.9432e-007,+8.3947e-008, ...
+0.0000e+000,-2.5711e-001,-1.5255e-002,-1.2220e-003,-5.6574e-005, ...
+1.1500e-006,+1.0345e-006,-1.7116e-007,+1.9350e-009,+6.6840e-009]; 

at_mean = [ ... 
+1.6257e+001,+2.1224e+000,+9.2569e-001,-2.5974e+001,+1.4510e+000, ...
+9.2468e-002,-5.3192e-001,+2.1094e-001,-6.9210e-002,-3.4060e-002, ...
-4.6569e+000,+2.6385e-001,-3.6093e-002,+1.0198e-002,-1.8783e-003, ...
+7.4983e-001,+1.1741e-001,+3.9940e-002,+5.1348e-003,+5.9111e-003, ...
+8.6133e-006,+6.3057e-001,+1.5203e-001,+3.9702e-002,+4.6334e-003, ...
+2.4406e-004,+1.5189e-004,+1.9581e-007,+5.4414e-001,+3.5722e-001, ...
+5.2763e-002,+4.1147e-003,-2.7239e-004,-5.9957e-005,+1.6394e-006, ...
-7.3045e-007,-2.9394e+000,+5.5579e-002,+1.8852e-002,+3.4272e-003, ...
-2.3193e-005,-2.9349e-005,+3.6397e-007,+2.0490e-006,-6.4719e-008, ...
-5.2225e-001,+2.0799e-001,+1.3477e-003,+3.1613e-004,-2.2285e-004, ...
-1.8137e-005,-1.5177e-007,+6.1343e-007,+7.8566e-008,+1.0749e-009]; 

bt_mean = [ ... 
+0.0000e+000,+0.0000e+000,+1.0210e+000,+0.0000e+000,+6.0194e-001, ...
+1.2292e-001,+0.0000e+000,-4.2184e-001,+1.8230e-001,+4.2329e-002, ...
+0.0000e+000,+9.3312e-002,+9.5346e-002,-1.9724e-003,+5.8776e-003, ...
+0.0000e+000,-2.0940e-001,+3.4199e-002,-5.7672e-003,-2.1590e-003, ...
+5.6815e-004,+0.0000e+000,+2.2858e-001,+1.2283e-002,-9.3679e-003, ...
-1.4233e-003,-1.5962e-004,+4.0160e-005,+0.0000e+000,+3.6353e-002, ...
-9.4263e-004,-3.6762e-003,+5.8608e-005,-2.6391e-005,+3.2095e-006, ...
-1.1605e-006,+0.0000e+000,+1.6306e-001,+1.3293e-002,-1.1395e-003, ...
+5.1097e-005,+3.3977e-005,+7.6449e-006,-1.7602e-007,-7.6558e-008, ...
+0.0000e+000,-4.5415e-002,-1.8027e-002,+3.6561e-004,-1.1274e-004, ...
+1.3047e-005,+2.0001e-006,-1.5152e-007,-2.7807e-008,+7.7491e-009]; 

at_amp = [ ... 
-1.8654e+000,-9.0041e+000,-1.2974e-001,-3.6053e+000,+2.0284e-002, ...
+2.1872e-001,-1.3015e+000,+4.0355e-001,+2.2216e-001,-4.0605e-003, ...
+1.9623e+000,+4.2887e-001,+2.1437e-001,-1.0061e-002,-1.1368e-003, ...
-6.9235e-002,+5.6758e-001,+1.1917e-001,-7.0765e-003,+3.0017e-004, ...
+3.0601e-004,+1.6559e+000,+2.0722e-001,+6.0013e-002,+1.7023e-004, ...
-9.2424e-004,+1.1269e-005,-6.9911e-006,-2.0886e+000,-6.7879e-002, ...
-8.5922e-004,-1.6087e-003,-4.5549e-005,+3.3178e-005,-6.1715e-006, ...
-1.4446e-006,-3.7210e-001,+1.5775e-001,-1.7827e-003,-4.4396e-004, ...
+2.2844e-004,-1.1215e-005,-2.1120e-006,-9.6421e-007,-1.4170e-008, ...
+7.8720e-001,-4.4238e-002,-1.5120e-003,-9.4119e-004,+4.0645e-006, ...
-4.9253e-006,-1.8656e-006,-4.0736e-007,-4.9594e-008,+1.6134e-009]; 

bt_amp = [ ... 
+0.0000e+000,+0.0000e+000,-8.9895e-001,+0.0000e+000,-1.0790e+000, ...
-1.2699e-001,+0.0000e+000,-5.9033e-001,+3.4865e-002,-3.2614e-002, ...
+0.0000e+000,-2.4310e-002,+1.5607e-002,-2.9833e-002,-5.9048e-003, ...
+0.0000e+000,+2.8383e-001,+4.0509e-002,-1.8834e-002,-1.2654e-003, ...
-1.3794e-004,+0.0000e+000,+1.3306e-001,+3.4960e-002,-3.6799e-003, ...
-3.5626e-004,+1.4814e-004,+3.7932e-006,+0.0000e+000,+2.0801e-001, ...
+6.5640e-003,-3.4893e-003,-2.7395e-004,+7.4296e-005,-7.9927e-006, ...
-1.0277e-006,+0.0000e+000,+3.6515e-002,-7.4319e-003,-6.2873e-004, ...
-8.2461e-005,+3.1095e-005,-5.3860e-007,-1.2055e-007,-1.1517e-007, ...
+0.0000e+000,+3.1404e-002,+1.5580e-002,-1.1428e-003,+3.3529e-005, ...
+1.0387e-005,-1.9378e-006,-2.7327e-007,+7.5833e-009,-9.2323e-009]; 

% parameter t
t = sin(dlat);

% degree n and order m
n = 9;
m = 9;

% determine n!  (faktorielle)  moved by 1
dfac(1) = 1;
for i = 1:(2*n + 1)
  dfac(i+1) = dfac(i)*i;
end

% determine Legendre functions (Heiskanen and Moritz, Physical Geodesy, 1967, eq. 1-62)
for i = 0:n
    for j = 0:min(i,m)
        ir = floor((i - j)/2);
        sum = 0;
        for k = 0:ir
            sum = sum + (-1)^k*dfac(2*i - 2*k + 1)/dfac(k + 1)/dfac(i - k + 1)/dfac(i - j - 2*k + 1)*t^(i - j - 2*k);
        end 
% Legendre functions moved by 1
        P(i + 1,j + 1) = 1.d0/2^i*sqrt((1 - t^2)^(j))*sum;
    end
end 

% spherical harmonics
i = 0;
for n = 0:9
    for m = 0:n
        i = i + 1;
        aP(i) = P(n+1,m+1)*cos(m*dlon);
        bP(i) = P(n+1,m+1)*sin(m*dlon);
    end
end

% Geoidal height
undu = 0.d0;
for i = 1:55
   undu = undu + (a_geoid(i)*aP(i) + b_geoid(i)*bP(i));
end

% orthometric height
hort = dhgt - undu;

% Surface temperature on the geoid
atm = 0.d0;
ata = 0.d0;
for i = 1:55
    atm = atm + (at_mean(i)*aP(i) + bt_mean(i)*bP(i));
    ata = ata + (at_amp(i) *aP(i) + bt_amp(i) *bP(i));
end 
temp0 =  atm + ata*cos(doy/365.25d0*2*pi);

% height correction for temperature
temp = temp0 - 0.0065d0*hort;
      
% Surface pressure on the geoid
apm = 0.d0;
apa = 0.d0;
for i = 1:55
    apm = apm + (ap_mean(i)*aP(i) + bp_mean(i)*bP(i));
    apa = apa + (ap_amp(i) *aP(i) + bp_amp(i) *bP(i));
end 
pres0  = apm + apa*cos(doy/365.25d0*2.d0*pi);

% height correction for pressure
pres = pres0*exp(-9.80665d0*hort/287.d0/(temp+273.15d0));

